var allow_notif_1on1_btn=document.getElementById("allow_notif_1on1_btn");function log_notif_allowance(e){var n=new FormData;n.append("status_code",e);var t=new XMLHttpRequest;t.open("POST","/1-on-1/push-notif/allow-attempt/"),t.timeout=15e3,t.setRequestHeader("X-CSRFToken",get_cookie("csrftoken")),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.onload=function(){if(200!=this.status)throw new Error("Bad status code from server.")},t.onerror=function(){throw new Error("Network error galore")},t.ontimeout=function(e){throw new Error("XMLHttpRequest timed out")},t.send(n)}function askPermission(e){if(!!(window.Notification||window.webkitNotifications||navigator.mozNotification)&&"serviceWorker"in navigator&&"PushManager"in window)return e.preventDefault(),new Promise(function(n,e){var t=Notification.requestPermission(function(e){n(e)});t&&t.then(n,e)}).then(function(e){if("denied"===e)log_notif_allowance("1"),window.location.replace("/push-notification/subscription/denied/");else{if("default"!==e)return"granted"===e?void subscribeUserToPush():void dim_screen("off");log_notif_allowance("2"),window.location.replace("/push-notification/subscription/temporarily-denied/")}})}function subscribeUserToPush(){var t=document.getElementById("notif_pub_key"),e=document.getElementById("sw_loc");return navigator.serviceWorker.register(e.value).then(function(e){var n={userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(t.value)};return e.pushManager.subscribe(n)}).then(function(e){return sendSubscriptionToServer(JSON.stringify(e)),e})}function sendSubscriptionToServer(e){dim_screen("on","- allowing notification -");var n=document.getElementById("allow_tid"),t=document.getElementById("fts"),o=new FormData,i=JSON.parse(e);t.value&&"1"===t.value&&o.append("first_time_subscriber","1"),o.append("endpoint",i.endpoint),o.append("auth",i.keys.auth),o.append("p256dh",i.keys.p256dh),o.append("target_id",n.value);var r=new XMLHttpRequest;r.open("POST","/push-notification/subscription/save/"),r.timeout=15e3,r.setRequestHeader("X-CSRFToken",get_cookie("csrftoken")),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.onload=function(){if(200==this.status){var e=JSON.parse(this.responseText);window.location.replace(e.redirect)}else window.location.replace("/1-on-1/push-notif/failure/subscription-action/")},r.onerror=function(){window.location.replace("/1-on-1/push-notif/failure/subscription-action/")},r.ontimeout=function(e){window.location.replace("/1-on-1/push-notif/failure/subscription-action/")},r.onprogress=function(){},r.send(o)}function get_cookie(e){if(!e)return null;var n=("; "+document.cookie).split("; "+e+"=");return 2<=n.length?n.pop().split(";").shift():void 0}function urlBase64ToUint8Array(e){for(var n=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(n),o=new Uint8Array(t.length),i=0;i<t.length;++i)o[i]=t.charCodeAt(i);return o}function dim_screen(e,n){if("on"===e){(i=document.createElement("div")).id="notif_overlay",i.className="ovl",(r=document.createElement("div")).id="notif_preloader",r.className="outer_ldr";var t=document.createElement("div");t.className="ldr ma";var o=document.createElement("div");o.id="preloader_message",o.className="cap sp cs cgy mbl",o.insertAdjacentText("afterbegin",n),document.body.appendChild(i),document.body.appendChild(r),r.insertAdjacentElement("afterbegin",t),r.insertAdjacentElement("afterbegin",o),document.body.style.overflow="hidden"}if("off"===e){var i=document.getElementById("notif_overlay"),r=document.getElementById("notif_preloader");i&&i.parentNode.removeChild(i),r&&r.parentNode.removeChild(r),document.body.style.overflow="visible"}}allow_notif_1on1_btn&&(allow_notif_1on1_btn.onclick=askPermission);var notif_sending_btn=document.getElementById("send_notif_1on1_btn");function sendNotif(e){e.preventDefault();var n=document.getElementById("send_tid");if(n.value){dim_screen("on","- sending notification -");var t=new FormData;t.append("tid",n.value),t.append("dec","1");var o=new XMLHttpRequest;o.open("POST","/1-on-1/push-notif/send/"),o.timeout=35e3,o.setRequestHeader("X-CSRFToken",get_cookie("csrftoken")),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.onload=function(){var e=JSON.parse(this.responseText);this.status,window.location.replace(e.redirect)},o.onerror=function(){window.location.replace("push-notification/subscription/unavailable/")},o.ontimeout=function(e){window.location.replace("push-notification/subscription/unavailable/")},o.onprogress=function(){},o.send(t)}else window.location.replace("/push-notification/subscription/malformed-target/")}notif_sending_btn&&(notif_sending_btn.onclick=sendNotif);